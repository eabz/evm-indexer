services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: evm-indexer-clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./migrations:/docker-entrypoint-initdb.d:ro
    environment:
      CLICKHOUSE_DB: indexer
      CLICKHOUSE_USER: indexer
      CLICKHOUSE_PASSWORD: indexer
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - indexer-network

  indexer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: evm-indexer
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      - RUST_LOG=info
    command: >
      indexer
      --chain 1
      --database clickhouse://indexer:indexer@clickhouse:9000/indexer
      --rpcs https://long-late-firefly.quiknode.pro/4bb1e6b2dec8294938b6fdfdb7cf0cf70c4e97a2/
      --start-block 0
      --batch-size 10
    networks:
      - indexer-network
    restart: unless-stopped

volumes:
  clickhouse_data:
    driver: local

networks:
  indexer-network:
    driver: bridge
